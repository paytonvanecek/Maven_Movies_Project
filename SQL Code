-- All data is before 11-27-2012 as that is when request came in

-- 1) Gsearch seems to be the biggest driver. Could you pull monthly trends for gsearch sessions and orders so that we can showcase growth there?
SELECT YEAR(ws.created_at) AS Year,
	MONTH(ws.created_at) AS MONTH,
	COUNT(DISTINCT ws.website_session_id) AS sessions,
	COUNT(DISTINCT o.order_id) AS orders
FROM website_sessions ws
	LEFT JOIN orders o
		ON ws.website_session_id = o.website_session_id
WHERE ws.utm_source = 'gsearch'
	AND ws.created_at < '2012-11-27'
GROUP BY 1,2;
-- Gsearch sessions and orders growing are substaintially over time, orders have grown about 4x

-- 2) see similar monthly trend for Gsearch, but this time break out nonbrand and brand campaigns separately.
SELECT YEAR(ws.created_at) AS Year,
	MONTH(ws.created_at) AS MONTH,
	COUNT(DISTINCT CASE WHEN ws.utm_campaign = 'brand' THEN ws.website_session_id ELSE NULL END) AS brand_sessions,
	COUNT(DISTINCT CASE WHEN ws.utm_campaign = 'brand' THEN o.order_id ELSE NULL END) AS brand_orders,
    COUNT(DISTINCT CASE WHEN ws.utm_campaign = 'nonbrand' THEN ws.website_session_id ELSE NULL END) AS nonbrand_sessions,
	COUNT(DISTINCT CASE WHEN ws.utm_campaign = 'nonbrand' THEN o.order_id ELSE NULL END) AS nonbrand_orders
FROM website_sessions ws
	LEFT JOIN orders o
		ON ws.website_session_id = o.website_session_id
WHERE ws.utm_source = 'gsearch'
	AND ws.created_at < '2012-11-27'
GROUP BY 1,2;
-- Brand campaigns represent someone searching specifically for your business. This has dramatically increased over time, meaning our brand is growing.

-- 3) While on Gsearch, dive into nonbrand, pull out monthly sessions and orders split by device type? Want to identify our traffic sources
SELECT YEAR(ws.created_at) AS Year,
	MONTH(ws.created_at) AS MONTH,
	COUNT(DISTINCT CASE WHEN ws.device_type = 'mobile' THEN ws.website_session_id ELSE NULL END) AS mobile_sessions,
	COUNT(DISTINCT CASE WHEN ws.device_type = 'mobile' THEN o.order_id ELSE NULL END) AS mobile_orders,
	COUNT(DISTINCT CASE WHEN ws.device_type = 'desktop' THEN ws.website_session_id ELSE NULL END) AS desktop_sessions,
	COUNT(DISTINCT CASE WHEN ws.device_type = 'desktop' THEN o.order_id ELSE NULL END) AS desktop_orders
FROM website_sessions ws
	LEFT JOIN orders o
		ON ws.website_session_id = o.website_session_id
WHERE ws.utm_source = 'gsearch'
	AND ws.utm_campaign = 'nonbrand'
	AND ws.created_at < '2012-11-27'
GROUP BY 1,2;
-- We see many more desktop sessions, more than 3x in recent months. Orders are even more drastic, almost 10x compared to mobile

-- 4) Worried about large % of traffic from Gsearch. Pull monthly trends for Gsearch, alongside monthly trends for each of our other channels
-- First, find the different channels
SELECT DISTINCT utm_source,
	http_referer
FROM website_sessions
WHERE created_at < '2012-11-27';
-- gsearch, bsearch, null
-- Where utm_source is null is an upaid session. If there is no referrer that means it was a direct type in

-- Break out into monthly trends by each of these channels
SELECT YEAR(created_at) AS Year,
	MONTH(created_at) AS MONTH,
	COUNT(DISTINCT CASE WHEN utm_source = 'gsearch' THEN website_session_id ELSE NULL END) AS gsearch_paid_sessions,
    COUNT(DISTINCT CASE WHEN utm_source = 'bsearch' THEN website_session_id ELSE NULL END) AS bsearch_paid_sessions,
	COUNT(DISTINCT CASE WHEN utm_source IS NULL AND http_referer IS NOT NULL THEN website_session_id ELSE NULL END) AS organic_search_sessions,
	COUNT(DISTINCT CASE WHEN utm_source IS NULL AND http_referer IS NULL THEN website_session_id ELSE NULL END) AS direct_sessions
FROM website_sessions
WHERE created_at < '2012-11-27'
GROUP BY 1,2;
-- We can see sessions from our Gsearch and Bsearch paid sources. Organic sources come from the search engines, but are not from paid sources. Direct sessions are where the session was from a direct type in.
-- We can see all sources are growing over time and Gsearch is the greatest source. However organic and direct are also growing over time, which we do not need to pay for.

-- 5) Tell story of website performance over first 8 months. Pull session to order conversion rates, by month
SELECT Year(ws.created_at) AS year,
	MONTH(ws.created_at) AS month,
	COUNT(DISTINCT ws.website_session_id) AS sessions,
	COUNT(DISTINCT o.order_id) AS orders,
    COUNT(DISTINCT o.order_id) / COUNT(DISTINCT ws.website_session_id) AS conv_rt
FROM website_sessions ws
	LEFT JOIN orders o
		ON ws.website_session_id = o.website_session_id
WHERE ws.created_at < '2012-11-27'
GROUP BY Year(ws.created_at), MONTH(ws.created_at);
-- Conversion rate steadily rises over the first 8 months

-- 6) Perform a Gsearch landing page test for lander-1, estimate the revenue that test earned us (test was 6/19 - 7/28 
-- Find the first instance of /lander-1
SELECT pageview_url,
	MIN(website_pageview_id)
FROM website_pageviews
WHERE pageview_url = '/lander-1'
GROUP BY pageview_url;
-- 23504
-- Find the first page view and bounced sessions
WITH first_pv AS(
SELECT wp.website_session_id,
	MIN(wp.website_pageview_id) AS first_pv
FROM website_pageviews wp
	LEFT JOIN website_sessions ws
		ON wp.website_session_id = ws.website_session_id
WHERE wp.created_at < '2012-07-28'
	AND wp.website_pageview_id >= '23504'
    AND ws.utm_source = 'gsearch'
    AND ws.utm_campaign = 'nonbrand'
GROUP BY 1
),
-- Find entry url
entry_page AS(
SELECT fp.website_session_id,
	wp.pageview_url AS entry_page_url
FROM first_pv fp
	LEFT JOIN website_pageviews wp
		ON fp.first_pv = wp.website_pageview_id
)
-- find conversion rate
SELECT ep.entry_page_url,
	COUNT(DISTINCT ep.website_session_id) AS sessions,
	COUNT(DISTINCT o.order_id) AS orders,
    COUNT(DISTINCT o.order_id) / COUNT(DISTINCT ep.website_session_id) AS conv_rate,
    SUM(o.price_usd) AS revenue
FROM entry_page ep
	LEFT JOIN orders o
		ON ep.website_session_id = o.website_session_id
GROUP BY 1;
-- increase in conv rate is .0088
-- find the last time that /home was used
SELECT wp.pageview_url,
	MAX(ws.website_session_id) AS last_home
FROM website_pageviews wp
	LEFT JOIN website_sessions ws
		ON wp.website_session_id = ws.website_session_id
WHERE pageview_url = '/home'
	AND ws.utm_source = 'gsearch'
    AND ws.utm_campaign = 'nonbrand'
    AND ws.created_at < '2012-11-27'
GROUP BY pageview_url;
-- 17145 last website session routed to /home
-- how many sessions since
SELECT COUNT(DISTINCT ws.website_session_id) AS sessions_since
FROM website_pageviews wp
	LEFT JOIN website_sessions ws
		ON wp.website_session_id = ws.website_session_id
WHERE ws.utm_source = 'gsearch'
    AND ws.utm_campaign = 'nonbrand'
	AND ws.website_session_id > '17145'
    AND ws.created_at < '2012-11-27';
-- 22972 sessions since /home X .0088 conversions is about 202 additional orders since test ended 7/29
	-- ~4 months, so ~50 extra orders a month
