-- All data is before 11-27-2012 as that is when request came in

-- 1) Gsearch seems to be the biggest driver. Could you pull monthly trends for gsearch sessions and orders so that we can showcase growth there?
SELECT YEAR(ws.created_at) AS Year,
	MONTH(ws.created_at) AS MONTH,
	COUNT(DISTINCT ws.website_session_id) AS sessions,
	COUNT(DISTINCT o.order_id) AS orders
FROM website_sessions ws
	LEFT JOIN orders o
		ON ws.website_session_id = o.website_session_id
WHERE ws.utm_source = 'gsearch'
	AND ws.created_at < '2012-11-27'
GROUP BY 1,2;
-- Gsearch sessions and orders growing are substaintially over time, orders have grown about 4x

-- 2) see similar monthly trend for Gsearch, but this time break out nonbrand and brand campaigns separately.
SELECT YEAR(ws.created_at) AS Year,
	MONTH(ws.created_at) AS MONTH,
	COUNT(DISTINCT CASE WHEN ws.utm_campaign = 'brand' THEN ws.website_session_id ELSE NULL END) AS brand_sessions,
	COUNT(DISTINCT CASE WHEN ws.utm_campaign = 'brand' THEN o.order_id ELSE NULL END) AS brand_orders,
    COUNT(DISTINCT CASE WHEN ws.utm_campaign = 'nonbrand' THEN ws.website_session_id ELSE NULL END) AS nonbrand_sessions,
	COUNT(DISTINCT CASE WHEN ws.utm_campaign = 'nonbrand' THEN o.order_id ELSE NULL END) AS nonbrand_orders
FROM website_sessions ws
	LEFT JOIN orders o
		ON ws.website_session_id = o.website_session_id
WHERE ws.utm_source = 'gsearch'
	AND ws.created_at < '2012-11-27'
GROUP BY 1,2;
-- Brand campaigns represent someone searching specifically for your business. This has dramatically increased over time, meaning our brand is growing.

-- 3) While on Gsearch, dive into nonbrand, pull out monthly sessions and orders split by device type? Want to identify our traffic sources
SELECT YEAR(ws.created_at) AS Year,
	MONTH(ws.created_at) AS MONTH,
	COUNT(DISTINCT CASE WHEN ws.device_type = 'mobile' THEN ws.website_session_id ELSE NULL END) AS mobile_sessions,
	COUNT(DISTINCT CASE WHEN ws.device_type = 'mobile' THEN o.order_id ELSE NULL END) AS mobile_orders,
	COUNT(DISTINCT CASE WHEN ws.device_type = 'desktop' THEN ws.website_session_id ELSE NULL END) AS desktop_sessions,
	COUNT(DISTINCT CASE WHEN ws.device_type = 'desktop' THEN o.order_id ELSE NULL END) AS desktop_orders
FROM website_sessions ws
	LEFT JOIN orders o
		ON ws.website_session_id = o.website_session_id
WHERE ws.utm_source = 'gsearch'
	AND ws.utm_campaign = 'nonbrand'
	AND ws.created_at < '2012-11-27'
GROUP BY 1,2;
-- We see many more desktop sessions, more than 3x in recent months. Orders are even more drastic, almost 10x compared to mobile

-- 4) Worried about large % of traffic from Gsearch. Pull monthly trends for Gsearch, alongside monthly trends for each of our other channels
-- First, find the different channels
SELECT DISTINCT utm_source,
	http_referer
FROM website_sessions
WHERE created_at < '2012-11-27';
-- gsearch, bsearch, null
-- Where utm_source is null is an upaid session. If there is no referrer that means it was a direct type in

-- Break out into monthly trends by each of these channels
SELECT YEAR(created_at) AS Year,
	MONTH(created_at) AS MONTH,
	COUNT(DISTINCT CASE WHEN utm_source = 'gsearch' THEN website_session_id ELSE NULL END) AS gsearch_paid_sessions,
    COUNT(DISTINCT CASE WHEN utm_source = 'bsearch' THEN website_session_id ELSE NULL END) AS bsearch_paid_sessions,
	COUNT(DISTINCT CASE WHEN utm_source IS NULL AND http_referer IS NOT NULL THEN website_session_id ELSE NULL END) AS organic_search_sessions,
	COUNT(DISTINCT CASE WHEN utm_source IS NULL AND http_referer IS NULL THEN website_session_id ELSE NULL END) AS direct_sessions
FROM website_sessions
WHERE created_at < '2012-11-27'
GROUP BY 1,2;
-- We can see sessions from our Gsearch and Bsearch paid sources. Organic sources come from the search engines, but are not from paid sources. Direct sessions are where the session was from a direct type in.
-- We can see all sources are growing over time and Gsearch is the greatest source. However organic and direct are also growing over time, which we do not need to pay for.

-- 5) Tell story of website performance over first 8 months. Pull session to order conversion rates, by month
SELECT Year(ws.created_at) AS year,
	MONTH(ws.created_at) AS month,
	COUNT(DISTINCT ws.website_session_id) AS sessions,
	COUNT(DISTINCT o.order_id) AS orders,
    COUNT(DISTINCT o.order_id) / COUNT(DISTINCT ws.website_session_id) AS conv_rt
FROM website_sessions ws
	LEFT JOIN orders o
		ON ws.website_session_id = o.website_session_id
WHERE ws.created_at < '2012-11-27'
GROUP BY Year(ws.created_at), MONTH(ws.created_at);
-- Conversion rate steadily rises over the first 8 months

-- 6) Perform a Gsearch landing page test for lander-1, estimate the revenue that test earned us (test was 6/19 - 7/28) 
-- Find the first instance of /lander-1
SELECT pageview_url,
	MIN(website_pageview_id)
FROM website_pageviews
WHERE pageview_url = '/lander-1'
GROUP BY pageview_url;
-- 23504
-- Find the first page view
WITH first_pv AS(
SELECT wp.website_session_id,
	MIN(wp.website_pageview_id) AS first_pv
FROM website_pageviews wp
	LEFT JOIN website_sessions ws
		ON wp.website_session_id = ws.website_session_id
WHERE wp.created_at < '2012-07-28'
	AND wp.website_pageview_id >= '23504'
    AND ws.utm_source = 'gsearch'
    AND ws.utm_campaign = 'nonbrand'
GROUP BY 1
),
-- Find entry url
entry_page AS(
SELECT fp.website_session_id,
	wp.pageview_url AS entry_page_url
FROM first_pv fp
	LEFT JOIN website_pageviews wp
		ON fp.first_pv = wp.website_pageview_id
)
-- find conversion rate
SELECT ep.entry_page_url,
	COUNT(DISTINCT ep.website_session_id) AS sessions,
	COUNT(DISTINCT o.order_id) AS orders,
    COUNT(DISTINCT o.order_id) / COUNT(DISTINCT ep.website_session_id) AS conv_rate,
    SUM(o.price_usd) AS revenue
FROM entry_page ep
	LEFT JOIN orders o
		ON ep.website_session_id = o.website_session_id
GROUP BY 1;
-- increase in conv rate is .0088
-- find the last time that /home was used
SELECT wp.pageview_url,
	MAX(ws.website_session_id) AS last_home
FROM website_pageviews wp
	LEFT JOIN website_sessions ws
		ON wp.website_session_id = ws.website_session_id
WHERE pageview_url = '/home'
	AND ws.utm_source = 'gsearch'
    AND ws.utm_campaign = 'nonbrand'
    AND ws.created_at < '2012-11-27'
GROUP BY pageview_url;
-- 17145 last website session routed to /home
-- how many sessions since
SELECT COUNT(DISTINCT ws.website_session_id) AS sessions_since
FROM website_pageviews wp
	LEFT JOIN website_sessions ws
		ON wp.website_session_id = ws.website_session_id
WHERE ws.utm_source = 'gsearch'
    AND ws.utm_campaign = 'nonbrand'
	AND ws.website_session_id > '17145'
    AND ws.created_at < '2012-11-27';
-- 22972 sessions since /home X .0088 conversions is about 202 additional orders since test ended 7/29
	-- ~4 months, so ~50 extra orders a month

-- 7) From landing page test, show a conversion funnel from each of the two pages to orders (Jun 19 - Jul 28)
-- Find the first instance of /lander-1
SELECT pageview_url,
	MIN(website_pageview_id)
FROM website_pageviews
WHERE pageview_url = '/lander-1'
GROUP BY pageview_url;
-- pv id 23504
-- Find the relevant page views
SELECT ws.website_session_id,
	wp.pageview_url,
	CASE WHEN wp.pageview_url = '/home' THEN 1 ELSE 0 END AS home_page,
    CASE WHEN wp.pageview_url = '/lander-1' THEN 1 ELSE 0 END AS lander1_page,
    CASE WHEN wp.pageview_url = '/products' THEN 1 ELSE 0 END AS products_page,
    CASE WHEN wp.pageview_url = '/the-original-mr-fuzzy' THEN 1 ELSE 0 END AS mrfuzzy_page,
    CASE WHEN wp.pageview_url = '/cart' THEN 1 ELSE 0 END AS cart_page,
    CASE WHEN wp.pageview_url = '/shipping' THEN 1 ELSE 0 END AS shipping_page,
    CASE WHEN wp.pageview_url = '/billing' THEN 1 ELSE 0 END AS billing_page,
    CASE WHEN wp.pageview_url = '/thank-you-for-your-order' THEN 1 ELSE 0 END AS thankyou_page
FROM website_sessions ws
	LEFT JOIN website_pageviews wp
		ON ws.website_session_id = wp.website_session_id
WHERE wp.created_at BETWEEN '2012-06-19' AND '2012-07-28'
	AND wp.website_pageview_id >= '23504'
    AND ws.utm_source = 'gsearch'
    AND ws.utm_campaign = 'nonbrand'
    AND wp.pageview_url IN ('/home','/lander-1','/products','/the-original-mr-fuzzy','/cart','/shipping','/billing','/thank-you-for-your-order')
GROUP BY 1,2;
-- group by website session id
WITH pages_viewed AS (
SELECT website_session_id,
	MAX(home_page) AS home_madeit,
    MAX(lander1_page) AS lander1_madeit,
	MAX(products_page) AS products_madeit,
	MAX(mrfuzzy_page) AS mrfuzzy_madeit,
    MAX(cart_page) AS cart_madeit,
	MAX(shipping_page) AS shipping_madeit,
	MAX(billing_page) AS billing_madeit,
    MAX(thankyou_page) AS thankyou_madeit
FROM(
	SELECT ws.website_session_id,
	wp.pageview_url,
	CASE WHEN wp.pageview_url = '/home' THEN 1 ELSE 0 END AS home_page,
    CASE WHEN wp.pageview_url = '/lander-1' THEN 1 ELSE 0 END AS lander1_page,
    CASE WHEN wp.pageview_url = '/products' THEN 1 ELSE 0 END AS products_page,
	CASE WHEN wp.pageview_url = '/the-original-mr-fuzzy' THEN 1 ELSE 0 END AS mrfuzzy_page,
    CASE WHEN wp.pageview_url = '/cart' THEN 1 ELSE 0 END AS cart_page,
    CASE WHEN wp.pageview_url = '/shipping' THEN 1 ELSE 0 END AS shipping_page,
    CASE WHEN wp.pageview_url = '/billing' THEN 1 ELSE 0 END AS billing_page,
    CASE WHEN wp.pageview_url = '/thank-you-for-your-order' THEN 1 ELSE 0 END AS thankyou_page
FROM website_sessions ws
	LEFT JOIN website_pageviews wp
		ON ws.website_session_id = wp.website_session_id
WHERE wp.created_at BETWEEN '2012-06-19' AND '2012-07-28'
	AND wp.website_pageview_id >= '23504'
    AND ws.utm_source = 'gsearch'
    AND ws.utm_campaign = 'nonbrand'
    AND wp.pageview_url IN ('/home','/lander-1', '/products','/the-original-mr-fuzzy','/cart','/shipping','/billing','/thank-you-for-your-order')
GROUP BY 1,2
) AS pageview_level
GROUP BY 1
)
-- Find the count and rate
SELECT wp.pageview_url,
	COUNT(DISTINCT wp.website_session_id) AS sessions,
    COUNT(DISTINCT CASE WHEN pv.products_madeit = 1 THEN pv.website_session_id ELSE NULL END) / COUNT(DISTINCT wp.website_session_id) AS entry_clk_rate,
    COUNT(DISTINCT CASE WHEN pv.mrfuzzy_madeit = 1 THEN pv.website_session_id ELSE NULL END) / COUNT(DISTINCT CASE WHEN pv.products_madeit = 1 THEN pv.website_session_id ELSE NULL END) AS products_clk_rate,
    COUNT(DISTINCT CASE WHEN pv.cart_madeit = 1 THEN pv.website_session_id ELSE NULL END) / COUNT(DISTINCT CASE WHEN pv.mrfuzzy_madeit = 1 THEN pv.website_session_id ELSE NULL END) AS mrfuzzy_clk_rate,
    COUNT(DISTINCT CASE WHEN pv.shipping_madeit = 1 THEN pv.website_session_id ELSE NULL END) / COUNT(DISTINCT CASE WHEN pv.cart_madeit = 1 THEN pv.website_session_id ELSE NULL END) AS cart_clk_rate,
    COUNT(DISTINCT CASE WHEN pv.billing_madeit = 1 THEN pv.website_session_id ELSE NULL END) / COUNT(DISTINCT CASE WHEN pv.shipping_madeit = 1 THEN pv.website_session_id ELSE NULL END) AS shipping_clk_rate,
    COUNT(DISTINCT CASE WHEN pv.thankyou_madeit = 1 THEN pv.website_session_id ELSE NULL END) / COUNT(DISTINCT CASE WHEN pv.billing_madeit = 1 THEN pv.website_session_id ELSE NULL END) AS billing_clk_rate,
    COUNT(DISTINCT CASE WHEN pv.thankyou_madeit = 1 THEN pv.website_session_id ELSE NULL END) / COUNT(DISTINCT wp.website_session_id) AS order_rate,
    COUNT(DISTINCT CASE WHEN pv.thankyou_madeit = 1 THEN pv.website_session_id ELSE NULL END) AS order_sessions
FROM pages_viewed pv
LEFT JOIN website_pageviews wp
	ON pv.website_session_id = wp.website_session_id
WHERE wp.pageview_url IN ('/home','/lander-1')
GROUP BY 1;
-- lander-1 saw a higher click through rate as well as a higher order rate

-- 8) Quantify the impact of our billing test. Analyze lift from test (Sep 10 - Nov 10), in terms of revenue per billing page session. Then pul the number of billing page sessions for the past month to analyze monthly impact
SELECT wp.website_session_id,
	wp.pageview_url AS billing_version_seen,
    o.order_id,
    o.price_usd
FROM website_pageviews wp
	LEFT JOIN orders o
		ON wp.website_session_id = o.website_session_id
WHERE wp.created_at BETWEEN '2012-09-10' AND '2012-11-10'
    AND wp.pageview_url IN ('/billing','/billing-2');
    
SELECT billing_version_seen,
	COUNT(DISTINCT website_session_id) AS sessions,
	SUM(price_usd) / COUNT(DISTINCT website_session_id) AS rev_per_biling_page_seen
FROM (
SELECT wp.website_session_id,
	wp.pageview_url AS billing_version_seen,
    o.order_id,
    o.price_usd
FROM website_pageviews wp
	LEFT JOIN orders o
		ON wp.website_session_id = o.website_session_id
WHERE wp.created_at BETWEEN '2012-09-10' AND '2012-11-10'
    AND wp.pageview_url IN ('/billing','/billing-2')
) AS billing_version
GROUP BY 1;
-- $22.83 rev per billing page seen for old version, $31.34 for new version. $8.51 increase
-- past month sessions
SELECT COUNT(DISTINCT website_session_id) AS sessions_in_test
FROM website_pageviews
WHERE created_at BETWEEN '2012-10-27' AND '2012-11-27'
	AND pageview_url IN ('/billing','/billing-2');
-- 1193 sessions in past month, X 8.51 (increase per session) = $10,152 over past month
